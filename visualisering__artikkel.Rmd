---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r Packages, include=FALSE}
#libraries:
pacman::p_load(tidyverse, readxl, viridis, pheatmap, RColorBrewer, fmsb, hrbrthemes, viridis, colormap)


```

```{r}
index <- read_xlsx("index med kategorier unpivoted.xlsx", sheet = "Sheet9")

index$GBR <- replace_na(index$GBR, 0)


index %>% pivot_wider(c("UnitCode"), names_from = c("GBR", "PRT", "POL", "NOR", "NLD"), values_from = c("GBR", "PRT", "POL", "NOR", "NLD"))

test <- index %>% pivot_longer(c("GBR", "PRT", "POL", "NOR", "NLD"), names_to = "Countries", values_to = "values", )


trt <- test %>% select("UnitCode", Countries, values)


ggplot(trt) + 
  geom_col(aes(x = UnitCode, y = values, group=Countries, fill=Countries), position = "dodge") + coord_flip() + scale_x_discrete(label = function(x) stringr::str_trunc(x, 12))

```

```{r}

orderlist <- trt %>% select(UnitCode) %>% distinct() %>% as.list() %>% unlist()

trt$UnitCode <- factor(trt$UnitCode, levels = orderlist)

a <- c("Give nutrition education and skills", "Nutrition advice and counselling in health care settings" , "Inform people about food and nutrition through public awareness", 
"Harness food supply chain and actions across sectors to ensure coherence with health",
"Set incentives and rules to create a healthy retail and food service environment", 
"Improve nutritional quality of the whole food supply", 
"Restrict food advertising and other forms of commercial promotion", 
"Use economic tools to address food affordability and purchase incentives", 
"Offer healthy food and set standards in public institutions and other specific settings", 
"Nutrition label standards and regulations on the use of claims and implied claims on food")

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ggplot(trt, aes(fill=Countries, y=values, x=UnitCode, group=Countries)) + 
    geom_bar(position = "dodge", stat="identity", colour = "black", width=0.45) +
    xlab("") +
    coord_flip() +
    scale_x_discrete(limits = a, label = function(x) stringr::substr(x,1,1)) +
    geom_hline(yintercept=c(25, 50, 75, 100), linetype='dashed', colour=c('red', 'orange', 'yellow', 'green'), show.legend = T)

        #scale_x_discrete(label = function(x) stringr::str_trunc(x, 12))
    
```


```{r}
trt <- trt[order(trt$UnitCode, trt$values, decreasing = T), ]


trt$fills <- case_when(trt$values < 25 ~ "Red",
                       trt$values < 50 ~ "Orange",
                       trt$values < 75 ~ "Yellow",
                       trt$values < 199 ~ "Green")

trt$fills <- factor(trt$fills, levels = rev(c("Red","Orange", "Yellow", "Green")))

trt$labels$Countries 

ggplot(trt, aes(y=values, x=UnitCode, group=Countries, order(rev(fills)))) + 
  theme_gray() +
  theme(axis.text.y = element_text(size = 11, face = "bold"), legend.position="bottom") + 
  #annotate("rect", ymin=0,ymax=25, xmin = 0, xmax = 10.5, alpha = 0.2, fill = "red") + 
  #annotate("rect", ymin=25,ymax=50, xmin = 0, xmax = 10.5, alpha = 0.2, fill = "orange") +
  #annotate("rect", ymin=50,ymax=75, xmin = 0, xmax = 10.5, alpha = 0.2, fill = "yellow") +
  #annotate("rect", ymin=75,ymax=100, xmin = 0, xmax = 10.5, alpha = 0.2, fill = "green") +
  facet_grid(~ Countries, labeller = labeller(Countries = 
    c("GBR" = "United Kingdom",
      "NLD" = "The Netherlands",
      "NOR" = "Norway",
      "POL" = "Poland",
      "PRT" = "Portugal"))) + 
  #geom_hline(aes(yintercept = 25), colour = "red", linetype='dashed')+
  #geom_hline(aes(yintercept = 50), colour = "orange", linetype='dashed')+
  #geom_hline(aes(yintercept = 75), colour = "yellow", linetype='dashed')+
  #geom_hline(aes(yintercept = 100), colour = "green", linetype='dashed')+
  geom_bar(position = "dodge", stat="identity", colour = "black", width=0.45, aes(fill=fills)) +
  scale_fill_manual(values = rev(c("Red","Orange", "Yellow", "Green")), labels= rev(c("Poor or non-existing", "Low quality", "Moderate quality", "High quality"))) +
  coord_flip() + 
  scale_x_discrete(limits= a, label = function(x) substr(x,1,1)) + 
  xlab("Policy area") + 
  ylab("Score (range 0 - 100)") +
  labs(fill='Outcome category', group=c("1", "2")) 
  
    
```

# Heatmaps
```{r}
index_clean <- index %>% as.data.frame()

index_clean$UnitCode <- sapply(index_clean$UnitCode, function(x) stringr::str_trunc(x, 20))

index_clean <- index_clean %>% as.data.frame()

rownames(index_clean) <- index_clean$UnitCode

index_clean

index_clean <- index_clean %>% select(-UnitCode, -gjsnitt)

#Make the heatmap
all_cluster <- pheatmap::pheatmap(index_clean, 
                                  show_rownames = T, 
                                  cluster_cols=F, 
                                  cluster_rows = F, 
                                  scale = "none", 
                                  border_colour = "black",
                                  color = colorRampPalette(c("red", "orange", "yellow", "forestgreen"))(50),
                                  display_numbers = T, 
                                  number_format = "%.0f", 
                                  cutree_rows = 3, 
                                  number_color = "black",
                                  legend_breaks = c(25, 50, 75, 100),
                                  legend_labels = c("Very little or non-existing", "Low quality", "Moderate quality", "High quality"))

```
# Gauge chart

```{r}

mytitle <- c("GBR", "2", "3", "4", "5")
  
colors_border=colormap(colormap=colormaps$viridis, nshades=6, alpha=1)
colors_in=colormap(colormap=colormaps$viridis, nshades=6, alpha=0.3)

for(i in 1:6){

  # Custom the radarChart !
  radarchart(trt[1,2,i+2),], axistype=1, 
  
    #custom polygon
    pcol=colors_border[i] , pfcol=colors_in[i] , plwd=4, plty=1 , 
  
    #custom the grid
    cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,20,5), cglwd=0.8,
  
    #custom labels
    vlcex=0.8,
    
    #title
    title=mytitle[i]
    )
}
```

